name: RPC Integration Tests

on:
  push:
    branches: [main, develop]
    paths:
      - "src/services/rpc*.ts"
      - "src/test/rpc/**"
      - "src/test/rpc*.test.ts"
      - "src/test/mocks/**"
  pull_request:
    branches: [main]
    paths:
      - "src/services/rpc*.ts"
      - "src/test/rpc/**"
      - "src/test/rpc*.test.ts"
      - "src/test/mocks/**"
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: "0 2 * * *"
  workflow_dispatch:
    inputs:
      test_category:
        description: "Test category to run"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - unit
          - integration
          - performance
      verbose:
        description: "Enable verbose output"
        required: false
        default: false
        type: boolean
      coverage:
        description: "Generate coverage reports"
        required: false
        default: true
        type: boolean

env:
  NODE_VERSION: "18"
  TIMEOUT_MS: "60000"

jobs:
  test:
    name: RPC Integration Tests
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [16, 18, 20]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: Install dependencies
        run: |
          npm ci
          npm run build

      - name: Compile TypeScript
        run: |
          npx tsc --noEmit --skipLibCheck

      - name: Run RPC Unit Tests
        run: |
          cd src/test
          node rpcRequests.test.ts

      - name: Run RPC Response Processing Tests
        run: |
          cd src/test
          node rpcResponseProcessing.test.ts

      - name: Run RPC Error Handling Tests
        run: |
          cd src/test
          node rpcErrorHandling.test.ts

      - name: Run RPC Connection Pooling Tests
        run: |
          cd src/test
          node rpcConnectionPooling.test.ts

      - name: Run RPC Rate Limiting Tests
        run: |
          cd src/test
          node rpcRateLimiting.test.ts

      - name: Run RPC Cleanup Tests
        run: |
          cd src/test
          node rpcCleanup.test.ts

      - name: Run RPC Integration Tests
        run: |
          cd src/test
          node rpc.integration.test.ts

      - name: Run All Tests with Test Runner
        run: |
          cd src/test
          node rpc-test-runner.ts --coverage --verbose

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: rpc-test-results-node-${{ matrix.node-version }}
          path: |
            src/test/test-results/
            src/test/coverage/
          retention-days: 7

      - name: Publish Test Results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: RPC Tests (Node ${{ matrix.node-version }})
          path: src/test/test-results/*.xml
          reporter: jest-junit

      - name: Comment PR with Results
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request' && always()
        with:
          script: |
            const fs = require('fs');
            const path = 'src/test/test-results/rpc-test-results.json';

            if (fs.existsSync(path)) {
              const results = JSON.parse(fs.readFileSync(path, 'utf8'));
              const summary = results.summary;

              const comment = `
              ## RPC Integration Test Results

              **Node Version:** ${{ matrix.node-version }}

              **Summary:**
              - Total Tests: ${summary.total}
              - ‚úÖ Passed: ${summary.passed}
              - ‚ùå Failed: ${summary.failed}
              - üìä Success Rate: ${((summary.passed / summary.total) * 100).toFixed(1)}%
              - ‚è±Ô∏è Duration: ${summary.duration}ms

              **Test Suites:**
              ${results.results.map(r =>
                `- ${r.name}: ${r.passed}/${r.total} (${((r.passed / r.total) * 100).toFixed(1)}%)`
              ).join('\n')}
              `;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

  performance:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: |
          npm ci
          npm run build

      - name: Run Performance Tests
        run: |
          cd src/test
          node rpc-test-runner.ts --category performance --coverage --verbose

      - name: Upload performance results
        uses: actions/upload-artifact@v4
        with:
          name: rpc-performance-results
          path: src/test/test-results/
          retention-days: 30

      - name: Update Performance Badge
        uses: schneegans/dynamic-badges@v1.0.0
        with:
          auth: ${{ secrets.GITHUB_TOKEN }}
          label: RPC Tests
          message: ${{ steps.performance.outputs.result }}
          color: ${{ steps.performance.outputs.color }}

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Run security audit
        run: |
          npm audit --audit-level=moderate

      - name: Run CodeQL Analysis
        uses: github/codeql-action/analyze@v2
        with:
          languages: typescript

  coverage:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: |
          npm ci
          npm run build

      - name: Generate coverage report
        run: |
          cd src/test
          node rpc-test-runner.ts --coverage --verbose

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./src/test/coverage/lcov.info
          flags: rpc-tests
          name: rpc-integration-tests
          fail_ci_if_error: false

  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [test, performance]
    if: always()

    steps:
      - name: Notify Slack on Success
        if: needs.test.result == 'success'
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: "#stellar-suite-ci"
          text: "‚úÖ RPC Integration Tests passed successfully!"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack on Failure
        if: needs.test.result == 'failure'
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: "#stellar-suite-ci"
          text: "‚ùå RPC Integration Tests failed! Please check the logs."
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  cleanup:
    name: Cleanup Old Artifacts
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
      - name: Delete old artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            const oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);

            for (const artifact of artifacts.data.artifacts) {
              if (new Date(artifact.created_at) < oneWeekAgo) {
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id
                });
                console.log(`Deleted artifact: ${artifact.name}`);
              }
            }
